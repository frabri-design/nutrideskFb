<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriDesk FB</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0F1A33">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NutriDesk FB">
<meta name="theme-color" content="#0F1A33">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;
        const getAirtableConfig = () => {
    const config = localStorage.getItem('nutridesk_airtable');
    return config ? JSON.parse(config) : null;
};

const saveAirtableConfig = (apiKey, baseId, patientsTableId, visitsTableId) => {
    const config = { apiKey, baseId, patientsTableId, visitsTableId };
    localStorage.setItem('nutridesk_airtable', JSON.stringify(config));
};

const airtableRequest = async (tableId, method = 'GET', body = null, recordId = null) => {
    const config = getAirtableConfig();
    if (!config) throw new Error('Configurazione Airtable mancante');
    
    const url = recordId 
        ? `https://api.airtable.com/v0/${config.baseId}/${tableId}/${recordId}`
        : `https://api.airtable.com/v0/${config.baseId}/${tableId}`;
    
    const options = {
        method,
        headers: {
            'Authorization': `Bearer ${config.apiKey}`,
            'Content-Type': 'application/json'
        }
    };
    
    if (body) options.body = JSON.stringify(body);
    
    const response = await fetch(url, options);
    if (!response.ok) throw new Error(`Airtable error: ${response.status}`);
    return await response.json();
};
        const IconLock = () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>;
        const IconTrash = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const IconEdit = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const IconPlus = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const IconSearch = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
        const IconSettings = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const IconChevronRight = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
        const IconActivity = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
        const IconCalendar = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const IconTrendDown = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" /></svg>;
        const IconTrendUp = ({size=20}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>;
        const IconUser = ({size=48}) => <svg style={{width: size, height: size}} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        
        const App = () => {
            const [isLocked, setIsLocked] = useState(() => {
    const lastActivity = localStorage.getItem('nutridesk_lastActivity');
    if (!lastActivity) return true;
    const fiveMinutes = 5 * 60 * 1000;
    return (Date.now() - parseInt(lastActivity)) > fiveMinutes;
});
            const [currentPin, setCurrentPin] = useState(() => localStorage.getItem('nutridesk_pin') || '1234');
            const [pin, setPin] = useState('');
            const [showChangePin, setShowChangePin] = useState(false);
            const [newPinData, setNewPinData] = useState({ old: '', new: '', confirm: '' });
            const [view, setView] = useState('list');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [showForm, setShowForm] = useState(null);
            const [editingIdx, setEditingIdx] = useState(null);
            const [formData, setFormData] = useState({});
            const [patients, setPatients] = useState([]);
const [loading, setLoading] = useState(false);
const [syncing, setSyncing] = useState(false);
            const [showSetup, setShowSetup] = useState(false);
const [setupData, setSetupData] = useState({ apiKey: '', baseId: '', patientsTableId: '', visitsTableId: '' });
            // Aggiorna timestamp attivit√† ogni azione
React.useEffect(() => {
    if (!isLocked) {
        const config = getAirtableConfig();
        if (!config) {
            setShowSetup(true);
        } else {
            loadFromAirtable();
        }
    }
}, [isLocked]);

React.useEffect(() => {
    const updateActivity = () => {
        if (!isLocked) {
            localStorage.setItem('nutridesk_lastActivity', Date.now().toString());
        }
    };
    window.addEventListener('click', updateActivity);
    window.addEventListener('touchstart', updateActivity);
    return () => {
        window.removeEventListener('click', updateActivity);
        window.removeEventListener('touchstart', updateActivity);
    };
}, [isLocked]);

const loadFromAirtable = async () => {
    setLoading(true);
    try {
        const config = getAirtableConfig();
        const patientsData = await airtableRequest(config.patientsTableId);
        const visitsData = await airtableRequest(config.visitsTableId);     
        const patientsMap = patientsData.records.map(rec => {
            const fields = rec.fields;
            const patientVisits = visitsData.records
                .filter(v => v.fields.Paziente && v.fields.Paziente[0] === rec.id)
                .map(v => ({
                    date: v.fields['Data visita'] || '',
                    weight: parseFloat(v.fields.Peso) || 0,
                    bmi: v.fields.BMI || '',
                    circumferences: v.fields.Circonferenze || '',
                    notes: v.fields['Note visita'] || '',
                    airtableId: v.id
                }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const lastDate = patientVisits[0]?.date;
            const daysSince = lastDate ? Math.floor((new Date() - new Date(lastDate)) / 86400000) : 0;
            return {
                id: rec.id,
                name: fields['Nome e Cognome'] || '',
                birthDate: fields['Data di nascita'] || '',
                height: fields.Altezza || '',
                status: fields.Stato === 'Concluso' ? 'completed' : 'active',
                allergies: fields['Allergie/Intolleranze/Patologie rilevanti'] || '',
                notes: fields['Note principali'] || '',
                totalVisitsPurchased: fields['Visite totali'] || 0,
                visits: patientVisits,
                totalVisits: patientVisits.length,
                remainingVisits: (fields['Visite rimanenti'] || 0),
                lastVisit: lastDate,
                daysSinceLastVisit: daysSince
            };
        });

        setPatients(patientsMap.sort((a, b) => a.name.localeCompare(b.name)));
    } catch (error) {
        console.error('Errore:', error);
        alert('Errore caricamento dati');
    } finally {
        setLoading(false);
    }
};
            const saveSetup = () => {
    if (!setupData.apiKey || !setupData.baseId || !setupData.patientsTableId || !setupData.visitsTableId) {
        return alert('Tutti i campi sono obbligatori');
    }
    saveAirtableConfig(setupData.apiKey, setupData.baseId, setupData.patientsTableId, setupData.visitsTableId);
    setShowSetup(false);
    loadFromAirtable();
};   
            const calcAge = (bd) => {
                const t = new Date(), b = new Date(bd);
                let a = t.getFullYear() - b.getFullYear();
                if (t.getMonth() < b.getMonth() || (t.getMonth() === b.getMonth() && t.getDate() < b.getDate())) a--;
                return a;
            };

            const getBMIColor = (bmi) => {
                const n = parseFloat(bmi);
                if (n < 18.5) return 'bg-orange-100 text-orange-700 border-orange-300';
                if (n <= 24.9) return 'bg-green-100 text-green-700 border-green-300';
                if (n <= 29.9) return 'bg-orange-100 text-orange-700 border-orange-300';
                return 'bg-red-100 text-red-700 border-red-300';
            };

            const getBMILabel = (bmi) => {
                const n = parseFloat(bmi);
                if (n < 18.5) return 'Sottopeso';
                if (n <= 24.9) return 'Normopeso';
                if (n <= 29.9) return 'Sovrappeso';
                return 'Obeso';
            };

           const savePatient = async () => {
    if (!formData.name || !formData.birthDate) return alert('Nome e data obbligatori');
    setLoading(true);
    try {
        const airtableFields = {
            'Nome e Cognome': formData.name,
            'Data di nascita': formData.birthDate,
            'Altezza': formData.height ? parseInt(formData.height) : null,
            'Stato': formData.status === 'completed' ? 'Concluso' : 'Attivo',
            'Allergie/Intolleranze/Patologie rilevanti': formData.allergies || '',
            'Note principali': formData.notes || '',
            'Visite totali': formData.totalVisitsPurchased ? parseInt(formData.totalVisitsPurchased) : 0
        };

        const config = getAirtableConfig();
if (showForm === 'addPatient') {
    await airtableRequest(config.patientsTableId, 'POST', { fields: airtableFields });
} else {
    await airtableRequest(config.patientsTableId, 'PATCH', { fields: airtableFields }, selectedPatient);
}

        await loadFromAirtable();
        setShowForm(null);
        setFormData({});
    } catch (error) {
        alert('Errore salvataggio');
    } finally {
        setLoading(false);
    }
};
            const saveVisit = async () => {
    if (!formData.weight) return alert('Peso obbligatorio');
    setLoading(true);
    try {
        const airtableFields = {
            'Data visita': formData.date,
            'Paziente': [selectedPatient],
            'Peso': parseFloat(formData.weight),
            'BMI': formData.bmi ? parseFloat(formData.bmi) : null,
            'Circonferenze': formData.circumferences || '',
            'Note visita': formData.notes || ''
        };
const config = getAirtableConfig();
if (showForm === 'addVisit') {
    await airtableRequest(config.visitsTableId, 'POST', { fields: airtableFields });
} else {
    const patient = patients.find(p => p.id === selectedPatient);
    const visitId = patient.visits[editingIdx].airtableId;
    await airtableRequest(config.visitsTableId, 'PATCH', { fields: airtableFields }, visitId);
}
        
        await loadFromAirtable();
        setShowForm(null);
        setFormData({});
        setEditingIdx(null);
    } catch (error) {
        alert('Errore salvataggio');
    } finally {
        setLoading(false);
    }
};
const delPatient = async (id, e) => {
    if (e) e.stopPropagation();
    if (!window.confirm('Conferma eliminazione')) return;
    setLoading(true);
    try {
       const config = getAirtableConfig();
await airtableRequest(config.patientsTableId, 'DELETE', null, id);
        await loadFromAirtable();
        setView('list');
    } catch (error) {
        alert('Errore eliminazione');
    } finally {
        setLoading(false);
    }
};
           const delVisit = async (pid, idx, e) => {
    if (e) e.stopPropagation();
    if (!window.confirm('Conferma eliminazione')) return;
    setLoading(true);
    try {
        const patient = patients.find(p => p.id === pid);
        const visitId = patient.visits[idx].airtableId;
       const config = getAirtableConfig();
await airtableRequest(config.visitsTableId, 'DELETE', null, visitId);
        await loadFromAirtable();
    } catch (error) {
        alert('Errore eliminazione');
    } finally {
        setLoading(false);
    }
};

            const changePin = () => {
    if (newPinData.old !== currentPin) return alert('PIN attuale errato');
    if (newPinData.new.length !== 4) return alert('Nuovo PIN deve essere 4 cifre');
    if (newPinData.new !== newPinData.confirm) return alert('I PIN non corrispondono');
    localStorage.setItem('nutridesk_pin', newPinData.new);
    setCurrentPin(newPinData.new);
    setShowChangePin(false);
    setNewPinData({ old: '', new: '', confirm: '' });
    alert('PIN modificato con successo!');
};

            const filtered = patients.filter(p => {
                const search = (p.name + (p.allergies || '') + (p.notes || '')).toLowerCase().includes(searchTerm.toLowerCase());
                if (filterStatus === 'alert30') return search && p.daysSinceLastVisit >= 30 && p.daysSinceLastVisit < 60;
                if (filterStatus === 'alert60') return search && p.daysSinceLastVisit >= 60;
                if (filterStatus !== 'all') return search && p.status === filterStatus;
                return search;
            });

            if (isLocked) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-[#0F1A33] to-[#0F1A33] flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm">
                            <div className="text-center mb-6">
                                <div className="bg-[#FBF0ED] w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <div className="text-[#E8B49A]"><IconLock /></div>
                                </div>
                                <h1 className="text-3xl font-bold text-[#0F1A33] mb-2">NutriDesk FB</h1>
                                <p className="text-gray-500">Inserisci il tuo PIN</p>
                                {currentPin === '1234' && (
                                    <div className="mt-4 bg-orange-50 border-l-4 border-[#E8B49A] p-3 text-left">
                                        <p className="text-xs text-[#0F1A33] font-medium">PIN temporaneo: 1234</p>
                                        <p className="text-xs text-orange-400 mt-1">Modificalo nelle Impostazioni al primo accesso</p>
                                    </div>
                                )}
                            </div>
                            <input
                                type="password"
                                inputMode="numeric"
                                maxLength={4}
                                value={pin}
                                onChange={(e) => setPin(e.target.value)}
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                        if (pin === currentPin) { 
    setIsLocked(false); 
    setPin(''); 
    localStorage.setItem('nutridesk_lastActivity', Date.now().toString());
}
                                        else { alert('PIN errato'); setPin(''); }
                                    }
                                }}
                                className="w-full text-center text-3xl tracking-widest border-2 rounded-xl p-4 mb-6 focus:border-[#E8B49A] focus:outline-none"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                autoFocus
                            />
                            <button onClick={() => { if (pin === currentPin) { setIsLocked(false); setPin(''); } else { alert('PIN errato'); setPin(''); } }} className="w-full bg-[#0F1A33] text-white rounded-xl py-4 font-semibold hover:bg-[#0F1A33]">Sblocca</button>
                        </div>
                    </div>
                );
            }
if (showSetup) {
    return (
        <div className="min-h-screen bg-gray-50">
            <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6">
                <h2 className="text-2xl font-bold mb-2">Configurazione Airtable</h2>
                <p className="text-sm text-[#E8B49A]">Inserisci i dati del tuo database</p>
            </div>
            <div className="p-4 space-y-4">
                <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-2xl">
                    <p className="text-xs font-medium text-blue-800 mb-2">üìò Segui la guida</p>
                    <p className="text-xs text-blue-700">Crea il database Airtable e inserisci qui i dati di configurazione.</p>
                </div>
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Token Airtable *</label>
                    <input type="text" placeholder="patXXXXXXXX..." value={setupData.apiKey} onChange={(e) => setSetupData({...setupData, apiKey: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-sm" />
                </div>
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Base ID *</label>
                    <input type="text" placeholder="appXXXXXXXX" value={setupData.baseId} onChange={(e) => setSetupData({...setupData, baseId: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-sm" />
                </div>
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Pazienti *</label>
                    <input type="text" placeholder="tblXXXXXXXX" value={setupData.patientsTableId} onChange={(e) => setSetupData({...setupData, patientsTableId: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-sm" />
                </div>
                <div className="bg-white rounded-2xl p-5 shadow-sm">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Visite *</label>
                    <input type="text" placeholder="tblXXXXXXXX" value={setupData.visitsTableId} onChange={(e) => setSetupData({...setupData, visitsTableId: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-sm" />
                </div>
                <button onClick={saveSetup} className="w-full bg-[#E8B49A] text-[#0F1A33] rounded-xl py-4 font-semibold hover:bg-orange-500">Salva e continua</button>
            </div>
        </div>
    );
}
            if (showChangePin) {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6">
                            <button onClick={() => { setShowChangePin(false); setNewPinData({ old: '', new: '', confirm: '' }); }} className="text-white mb-4">‚Üê Annulla</button>
                            <h2 className="text-2xl font-bold">Cambia PIN</h2>
                        </div>
                        <div className="p-4 space-y-4">
                            <div className="bg-white rounded-2xl p-5 shadow-sm">
                                <label className="block text-sm font-medium text-gray-700 mb-2">PIN attuale</label>
                                <input type="password" inputMode="numeric" maxLength={4} value={newPinData.old} onChange={(e) => setNewPinData({...newPinData, old: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-center text-2xl tracking-widest" />
                            </div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Nuovo PIN</label>
                                <input type="password" inputMode="numeric" maxLength={4} value={newPinData.new} onChange={(e) => setNewPinData({...newPinData, new: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-center text-2xl tracking-widest" />
                            </div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Conferma nuovo PIN</label>
                                <input type="password" inputMode="numeric" maxLength={4} value={newPinData.confirm} onChange={(e) => setNewPinData({...newPinData, confirm: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none text-center text-2xl tracking-widest" />
                            </div>
                            <button onClick={changePin} className="w-full bg-[#E8B49A] text-white rounded-xl py-4 font-semibold hover:bg-orange-500">Salva nuovo PIN</button>
                        </div>
                    </div>
                );
            }
if (showForm) {
                const isPatient = showForm.includes('Patient');
                const isEdit = showForm.includes('edit');
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6 shadow-lg">
                            <button onClick={() => { setShowForm(null); setFormData({}); setEditingIdx(null); }} className="text-white mb-4">‚Üê Annulla</button>
                            <h2 className="text-2xl font-bold">{isEdit ? 'Modifica' : 'Nuovo'} {isPatient ? 'Paziente' : 'Visita'}</h2>
                        </div>
                        <div className="p-4 space-y-4 pb-24">
                            {isPatient ? (
                                <>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Nome e Cognome *</label><input type="text" placeholder="Mario Rossi" value={formData.name || ''} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Data di nascita *</label><input type="date" value={formData.birthDate || ''} onChange={(e) => setFormData({...formData, birthDate: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Altezza (cm)</label><input type="number" placeholder="170" value={formData.height || ''} onChange={(e) => setFormData({...formData, height: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Stato</label><select value={formData.status || 'active'} onChange={(e) => setFormData({...formData, status: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none"><option value="active">Attivo</option><option value="completed">Concluso</option></select></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Allergie / Intolleranze / Patologie / Esami</label><input type="text" placeholder="es. Lattosio" value={formData.allergies || ''} onChange={(e) => setFormData({...formData, allergies: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Note</label><textarea rows={3} placeholder="Obiettivi..." value={formData.notes || ''} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                               <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Visite totali pacchetto</label><input type="number" placeholder="7" value={formData.totalVisitsPurchased || ''} onChange={(e) => setFormData({...formData, totalVisitsPurchased: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                </>
                            ) : (
                                <>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Data visita *</label><input type="date" value={formData.date || new Date().toISOString().split('T')[0]} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Peso (kg) *</label><input type="number" step="0.1" placeholder="75.5" value={formData.weight || ''} onChange={(e) => setFormData({...formData, weight: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">BMI</label><input type="number" step="0.1" placeholder="24.5" value={formData.bmi || ''} onChange={(e) => setFormData({...formData, bmi: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /><p className="text-xs text-gray-500 mt-1">Calcolato da Airtable</p></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Circonferenze</label><input type="text" placeholder="Vita: 85cm, Fianchi: 100cm" value={formData.circumferences || ''} onChange={(e) => setFormData({...formData, circumferences: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                    <div className="bg-white rounded-2xl p-5 shadow-sm"><label className="block text-sm font-medium text-gray-700 mb-2">Note visita</label><textarea rows={3} placeholder="Annotazioni..." value={formData.notes || ''} onChange={(e) => setFormData({...formData, notes: e.target.value})} className="w-full border-2 rounded-xl p-3 focus:border-[#E8B49A] focus:outline-none" /></div>
                                </>
                            )}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
                            <button onClick={isPatient ? savePatient : saveVisit} className="w-full bg-[#E8B49A] text-[#0F1A33] rounded-xl py-4 font-semibold hover:bg-orange-500">Salva {isEdit ? 'Modifiche' : isPatient ? 'Paziente' : 'Visita'}</button>
                        </div>
                    </div>
                );
            }

            if (view === 'detail' && selectedPatient) {
                const p = patients.find(x => x.id === selectedPatient);
                if (!p) return null;
                const trend = p.visits.length >= 2 ? p.visits[0].weight - p.visits[p.visits.length - 1].weight : 0;
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6">
                            <button onClick={() => setView('list')} className="text-white mb-4">‚Üê Torna alla lista</button>
                            <div className="flex justify-between">
                                <div><h2 className="text-2xl font-bold">{p.name}</h2><p className="text-[#E8B49A] text-sm">{calcAge(p.birthDate)} anni{p.height ? ` ‚Ä¢ ${p.height} cm` : ''}</p></div>
                                <div className="flex gap-2">
                                    <button onClick={(e) => { e.stopPropagation(); setFormData({ name: p.name, birthDate: p.birthDate, height: p.height, allergies: p.allergies, notes: p.notes, status: p.status }); setShowForm('editPatient'); }} className="bg-blue-500 p-2 rounded-lg hover:bg-blue-600"><IconEdit size={20} /></button>
                                    <button onClick={(e) => delPatient(p.id, e)} className="bg-red-500 p-2 rounded-lg hover:bg-red-600"><IconTrash size={20} /></button>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 space-y-4">
                            <div className="bg-white rounded-2xl p-4">
    <div className="flex justify-between items-center mb-3">
        <span className={`px-3 py-1 rounded-full text-xs font-medium ${p.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>
            {p.status === 'active' ? 'Attivo' : 'Concluso'}
        </span>
        {p.daysSinceLastVisit > 60 && <div className="text-2xl">üî¥</div>}
    </div>
    <div className="grid grid-cols-3 gap-3 text-sm">
        <div><p className="text-gray-500">Ultima visita</p><p className="font-semibold">{p.lastVisit ? new Date(p.lastVisit).toLocaleDateString('it-IT') : '-'}</p><p className="text-xs text-gray-400">{p.daysSinceLastVisit || 0} giorni fa</p></div>
        <div><p className="text-gray-500">Visite fatte</p><p className="font-semibold text-2xl">{p.totalVisits}</p></div>
        <div><p className="text-gray-500">Rimanenti</p><p className="font-semibold text-2xl text-[#E8B49A]">{p.remainingVisits}</p></div>
    </div>
</div>
{p.allergies && (
    <div className="bg-red-50 border-l-4 border-red-400 rounded-r-2xl p-4">
        <p className="text-xs font-medium text-red-800 mb-1">
            ‚ö†Ô∏è ALLERGIE / INTOLLERANZE / PATOLOGIE / ESAMI
        </p>
        <p className="text-sm text-red-700 font-semibold">
            {p.allergies}
        </p>
    </div>
)}
                            {p.notes && <div className="bg-blue-50 rounded-2xl p-4"><p className="text-xs font-medium text-blue-800 mb-2">üìù Note principali</p><p className="text-sm text-gray-700">{p.notes}</p></div>}
                            {p.visits.length > 0 && <div className="bg-white rounded-2xl p-4 shadow-sm"><h3 className="font-semibold mb-3 flex items-center gap-2"><IconActivity size={18} />Andamento peso totale</h3><div className="flex items-center gap-4"><div className="text-3xl font-bold text-gray-800">{p.visits[0].weight} kg</div>{trend !== 0 && <div className={`flex items-center gap-1 ${trend < 0 ? 'text-green-600' : 'text-red-600'}`}>{trend < 0 ? <IconTrendDown size={20} /> : <IconTrendUp size={20} />}<span className="font-semibold">{Math.abs(trend).toFixed(1)} kg</span></div>}</div></div>}
                            <div className="bg-white rounded-2xl p-4 shadow-sm"><h3 className="font-semibold mb-3 flex items-center gap-2"><IconCalendar size={18} />Storico visite</h3>{p.visits.length === 0 ? <p className="text-gray-400 text-sm text-center py-4">Nessuna visita registrata</p> : <div className="space-y-3">{p.visits.map((v, i) => <div key={i} className="border-l-2 border-slate-300 pl-4 py-2 relative"><div className="absolute right-0 top-2 flex gap-2"><button onClick={(e) => { e.stopPropagation(); setFormData({ date: v.date, weight: v.weight.toString(), bmi: v.bmi || '', circumferences: v.circumferences || '', notes: v.notes || '' }); setEditingIdx(i); setShowForm('editVisit'); }} className="text-blue-500 hover:text-blue-700"><IconEdit size={16} /></button><button onClick={(e) => delVisit(p.id, i, e)} className="text-red-500 hover:text-red-700"><IconTrash size={16} /></button></div><div className="flex justify-between pr-16 mb-2"><p className="font-medium text-gray-800">{new Date(v.date).toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' })}</p><span className="text-[#0F1A33] font-semibold">{v.weight} kg</span></div>{v.bmi && <div className="mb-2"><span className={`inline-block px-2 py-1 rounded-full text-xs font-medium border ${getBMIColor(v.bmi)}`}>BMI: {v.bmi} - {getBMILabel(v.bmi)}</span></div>}{v.circumferences && <p className="text-xs text-gray-600 mb-1">{v.circumferences}</p>}{v.notes && <p className="text-sm text-gray-700 italic">{v.notes}</p>}</div>)}</div>}</div>
                            <button onClick={() => { setFormData({ date: new Date().toISOString().split('T')[0], weight: '', bmi: '', circumferences: '', notes: '' }); setShowForm('addVisit'); }} className="w-full bg-[#E8B49A] text-[#0F1A33] rounded-xl py-4 font-semibold hover:bg-orange-500 flex items-center justify-center gap-2"><IconPlus size={20} />Nuova visita</button>
                        </div>
                    </div>
                );
            }

            if (view === 'settings') {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6"><button onClick={() => setView('list')} className="text-white mb-4">‚Üê Torna indietro</button><h2 className="text-2xl font-bold">Come usare NutriDesk</h2></div>
                        <div className="p-4 space-y-4">
                            <div className="bg-white rounded-2xl p-5 shadow-sm"><h3 className="font-semibold mb-3 text-lg text-[#0F1A33]">üì± Dall'app mobile</h3><div className="space-y-3 text-sm text-gray-700"><div className="flex gap-3"><span className="font-bold text-[#E8B49A] flex-shrink-0">1.</span><p><strong>Aggiungi un paziente:</strong> Tocca "+ Nuovo paziente" in basso. Compila i campi e salva.</p></div><div className="flex gap-3"><span className="font-bold text-[#E8B49A] flex-shrink-0">2.</span><p><strong>Aggiungi una visita:</strong> Apri il paziente e tocca "+ Nuova visita". Inserisci peso, BMI, circonferenze e note.</p></div><div className="flex gap-3"><span className="font-bold text-[#E8B49A] flex-shrink-0">3.</span><p><strong>Cerca rapidamente:</strong> Usa la barra di ricerca in alto per trovare un paziente per nome, allergie o note.</p></div><div className="flex gap-3"><span className="font-bold text-[#E8B49A] flex-shrink-0">4.</span><p><strong>Filtra per stato:</strong> Usa i pulsanti per vedere solo Attivi, Alert 30gg, Alert 60gg o Conclusi.</p></div><div className="flex gap-3"><span className="font-bold text-[#E8B49A] flex-shrink-0">5.</span><p><strong>Modifica/Elimina:</strong> Nella scheda paziente o visita, usa le icone matita (modifica) o cestino (elimina).</p></div></div></div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm"><h3 className="font-semibold mb-3 text-lg text-[#0F1A33]">üíª Da computer (Airtable)</h3><p className="text-sm text-gray-700 mb-3">Puoi gestire tutti i dati anche da PC su Airtable. Le modifiche si sincronizzano automaticamente con l'app.</p><button className="w-full bg-[#FBF0ED] text-[#E8B49A] rounded-xl py-3 font-medium hover:bg-orange-200 transition mb-3 border-2 border-orange-200">Apri Airtable</button><a href="https://frabri-design.github.io/nutrideskFb/guida-airtable.html" target="_blank" rel="noopener noreferrer" className="block w-full bg-blue-50 text-blue-700 rounded-xl py-3 font-medium text-center border-2 border-blue-200 hover:bg-blue-100 transition">üìö Guida completa Setup Airtable</a></div>
                            <div className="bg-amber-50 rounded-2xl p-5 border-l-4 border-amber-400"><h3 className="font-semibold mb-2 text-amber-900">‚ö†Ô∏è Alert automatici</h3><p className="text-sm text-amber-800">L'app ti avvisa automaticamente quando un paziente non viene da tempo:<br/><span className="inline-block mt-2"><strong>üü° 30-59 giorni</strong> - Icona gialla</span><br/><span className="inline-block"><strong>üî¥ 60+ giorni</strong> - Icona rossa</span></p></div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm"><h3 className="font-semibold mb-3">üîÑ Sincronizzazione</h3><p className="text-sm text-gray-600 mb-3">Aggiorna dati da Airtable</p><button onClick={async () => { setSyncing(true); await loadFromAirtable(); setSyncing(false); alert('‚úÖ Sincronizzato!'); }} disabled={syncing} className="w-full bg-[#E8B49A] text-white rounded-xl py-3 font-medium">{syncing ? 'Sincronizzazione...' : 'Sincronizza ora'}</button></div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm">
    <h3 className="font-semibold mb-3">‚öôÔ∏è Configurazione Airtable</h3>
    <p className="text-sm text-gray-600 mb-3">Reset configurazione database</p>
    <button onClick={() => { 
        if (window.confirm('Vuoi resettare la configurazione Airtable? Dovrai reinserire tutti i dati.')) {
            localStorage.removeItem('nutridesk_airtable');
            setShowSetup(true);
        }
    }} className="w-full border-2 border-orange-400 text-orange-600 rounded-xl py-3 font-medium hover:bg-orange-50 transition">Reset configurazione</button>
</div>
                            <div className="bg-white rounded-2xl p-5 shadow-sm"><h3 className="font-semibold mb-3">üîí Sicurezza</h3><p className="text-sm text-gray-600 mb-3">Il tuo PIN protegge l'accesso ai dati dei pazienti.</p><button onClick={() => setShowChangePin(true)} className="w-full border-2 border-[#E8B49A] text-orange-600 rounded-xl py-3 font-medium hover:bg-orange-50 transition">Cambia PIN</button></div>
                            <div className="bg-gray-50 rounded-2xl p-5 text-center border-2 border-gray-100">
    <p className="text-xs text-gray-500 mb-2">¬© 2026 Dott.ssa Francesca Briscia</p>
    <p className="text-xs text-gray-400">NutriDesk FB - Tutti i diritti riservati</p>
    </div>
                            <button onClick={() => setIsLocked(true)} className="w-full bg-red-50 text-red-600 rounded-xl py-3 font-medium hover:bg-red-100 transition">Blocca app</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 pb-24">
                    <div className="bg-gradient-to-r from-[#0F1A33] to-[#0F1A33] text-white p-6 shadow-lg">
                        <div className="flex justify-between items-center mb-4"><h1 className="text-2xl font-bold">NutriDesk FB</h1><button onClick={() => setView('settings')} className="bg-white/20 p-2 rounded-lg hover:bg-white/30"><IconSettings size={20} /></button></div>
                        <div className="relative"><div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#0F1A33]"><IconSearch size={20} /></div><input type="text" placeholder="Cerca paziente..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-11 pr-4 py-3 rounded-xl text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#E8B49A]" /></div>
                    </div>
                    <div className="bg-white p-4 shadow-sm flex gap-2 overflow-x-auto">
                        {[{k: 'all', l: 'Tutti'}, {k: 'active', l: 'Attivi'}, {k: 'alert30', l: 'Alert 30gg'}, {k: 'alert60', l: 'Alert 60gg'}, {k: 'completed', l: 'Conclusi'}].map(s => <button key={s.k} onClick={() => setFilterStatus(s.k)} className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${filterStatus === s.k ? 'bg-[#0F1A33] text-white' : 'bg-orange-50 text-[#E8B49A] border-2 border-orange-200'}`}>{s.l} ({filtered.filter(p => { if (s.k === 'all') return true; if (s.k === 'alert30') return p.daysSinceLastVisit >= 30 && p.daysSinceLastVisit < 60; if (s.k === 'alert60') return p.daysSinceLastVisit >= 60; return p.status === s.k; }).length})</button>)}
                    </div>
                    <div className="p-4 space-y-3">{filtered.length === 0 ? <div className="text-center py-12 text-gray-400"><IconUser size={48} /><p className="mt-3">Nessun paziente. Tocca "+ Nuovo paziente"!</p></div> : filtered.map(p => <div key={p.id} onClick={() => { setSelectedPatient(p.id); setView('detail'); }} className="bg-white rounded-2xl p-4 shadow-sm cursor-pointer hover:shadow-md transition"><div className="flex justify-between items-start mb-2"><div><h3 className="font-semibold text-lg">{p.name}</h3><p className="text-sm text-gray-500">{calcAge(p.birthDate)} anni</p></div><div className="flex items-center gap-2">{p.daysSinceLastVisit > 60 && <div className="text-xl">üî¥</div>}{p.daysSinceLastVisit >= 30 && p.daysSinceLastVisit < 60 && <div className="text-xl">üü°</div>}<IconChevronRight size={20} /></div></div><span className={`px-2 py-1 rounded-full text-xs font-medium ${p.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`}>{p.status === 'active' ? 'Attivo' : 'Concluso'}</span><div className="flex justify-between text-xs text-gray-500 pt-2 mt-2 border-t"><span>Ultima: {p.daysSinceLastVisit || 0} gg fa</span><span>{p.totalVisits} visite</span></div></div>)}</div>
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4"><button onClick={() => { setFormData({ name: '', birthDate: '', height: '', allergies: '', notes: '', status: 'active' }); setShowForm('addPatient'); }} className="w-full bg-[#E8B49A] text-[#0F1A33] rounded-xl py-4 font-semibold hover:bg-orange-500 flex items-center justify-center gap-2"><IconPlus size={24} />Nuovo paziente</button></div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>



